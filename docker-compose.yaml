version: '3'

services:
  storage:
    image: flix-storage
    build:
      context: ./storage
      dockerfile: Dockerfile

    container_name: flix-storage

    ports:
      - "4001:80"

    environment:
      - PORT=80
      - DEBUG=storage*
      - STORAGE_BUCKET=videos
      - STORAGE_ENDPOINT=object-storage
      - STORAGE_KEY=${STORAGE_KEY}
      - STORAGE_SECRET=${STORAGE_SECRET}

    restart: "no"

  video-streaming:
    image: flix-streaming
    build:
      context: ./video-streaming
      dockerfile: Dockerfile

    container_name: flix-streaming

    ports:
      - "4000:80"

    environment:
      - PORT=80
      - DEBUG=video-streaming*
      - STORAGE_HOST=storage
      - STORAGE_PORT=80

    restart: "always"

  object-storage:
    image: quay.io/minio/minio
    command:
      - server
      - /data
      - --console-address
      - ":9090"

    environment:
      - MINIO_ROOT_USER=${STORAGE_KEY}
      - MINIO_ROOT_PASSWORD=${STORAGE_SECRET}

    ports:
      - "9000:9000"
      - "9090:9090"

    volumes:
      - $PWD/data/object:/data
